advisory_id: UBUNTU-CVE-2022-46169
datasource_id: ubuntu_osv_importer_v2/UBUNTU-CVE-2022-46169
datasource_url: https://github.com/canonical/ubuntu-security-notices/blob/main/osv/cve/2022/UBUNTU-CVE-2022-46169.json
aliases:
  - CVE-2022-46169
summary: 'Cacti is an open source platform which provides a robust and extensible operational
  monitoring and fault management framework for users. In affected versions a command injection
  vulnerability allows an unauthenticated user to execute arbitrary code on a server running
  Cacti, if a specific data source was selected for any monitored device. The vulnerability
  resides in the `remote_agent.php` file. This file can be accessed without authentication.
  This function retrieves the IP address of the client via `get_client_addr` and resolves this
  IP address to the corresponding hostname via `gethostbyaddr`. After this, it is verified that
  an entry within the `poller` table exists, where the hostname corresponds to the resolved
  hostname. If such an entry was found, the function returns `true` and the client is authorized.
  This authorization can be bypassed due to the implementation of the `get_client_addr` function.
  The function is defined in the file `lib/functions.php` and checks serval `$_SERVER` variables
  to determine the IP address of the client. The variables beginning with `HTTP_` can be arbitrarily
  set by an attacker. Since there is a default entry in the `poller` table with the hostname
  of the server running Cacti, an attacker can bypass the authentication e.g. by providing the
  header `Forwarded-For: <TARGETIP>`. This way the function `get_client_addr` returns the IP
  address of the server running Cacti. The following call to `gethostbyaddr` will resolve this
  IP address to the hostname of the server, which will pass the `poller` hostname check because
  of the default entry. After the authorization of the `remote_agent.php` file is bypassed,
  an attacker can trigger different actions. One of these actions is called `polldata`. The
  called function `poll_for_data` retrieves a few request parameters and loads the corresponding
  `poller_item` entries from the database. If the `action` of a `poller_item` equals `POLLER_ACTION_SCRIPT_PHP`,
  the function `proc_open` is used to execute a PHP script. The attacker-controlled parameter
  `$poller_id` is retrieved via the function `get_nfilter_request_var`, which allows arbitrary
  strings. This variable is later inserted into the string passed to `proc_open`, which leads
  to a command injection vulnerability. By e.g. providing the `poller_id=;id` the `id` command
  is executed. In order to reach the vulnerable call, the attacker must provide a `host_id`
  and `local_data_id`, where the `action` of the corresponding `poller_item` is set to `POLLER_ACTION_SCRIPT_PHP`.
  Both of these ids (`host_id` and `local_data_id`) can easily be bruteforced. The only requirement
  is that a `poller_item` with an `POLLER_ACTION_SCRIPT_PHP` action exists. This is very likely
  on a productive instance because this action is added by some predefined templates like `Device
  - Uptime` or `Device - Polling Time`. This command injection vulnerability allows an unauthenticated
  user to execute arbitrary commands if a `poller_item` with the `action` type `POLLER_ACTION_SCRIPT_PHP`
  (`2`) is configured. The authorization bypass should be prevented by not allowing an attacker
  to make `get_client_addr` (file `lib/functions.php`) return an arbitrary IP address. This
  could be done by not honoring the `HTTP_...` `$_SERVER` variables. If these should be kept
  for compatibility reasons it should at least be prevented to fake the IP address of the server
  running Cacti. This vulnerability has been addressed in both the 1.2.x and 1.3.x release branches
  with `1.2.23` being the first release containing the patch.'
impacted_packages:
  - purl: pkg:deb/ubuntu/cacti?arch=source&distro=esm-apps/bionic
    affected_versions: vers:deb/1.1.18+ds1-1|1.1.27+ds1-2|1.1.27+ds1-3|1.1.28+ds1-2|1.1.35+ds1-1|1.1.36+ds1-1|1.1.38+ds1-1|1.1.38+ds1-1ubuntu0.1~esm1|1.1.38+ds1-1ubuntu0.1~esm3
    fixed_versions: vers:deb/1.1.38+ds1-1ubuntu0.1~esm4
  - purl: pkg:deb/ubuntu/cacti?arch=source&distro=esm-apps/focal
    affected_versions: vers:deb/1.2.4+ds1-2ubuntu3|1.2.9+ds1-1ubuntu1|1.2.9+ds1-1ubuntu2|1.2.10+ds1-1ubuntu1|1.2.10+ds1-1ubuntu1+esm1|1.2.10+ds1-1ubuntu1.1|1.2.10+ds1-1ubuntu1.1+esm1
    fixed_versions: vers:deb/1.2.10+ds1-1ubuntu1.1+esm2
  - purl: pkg:deb/ubuntu/cacti?arch=source&distro=esm-apps/jammy
    affected_versions: vers:deb/1.2.16+ds1-2ubuntu1|1.2.19+ds1-2ubuntu1|1.2.19+ds1-2ubuntu1+esm1|1.2.19+ds1-2ubuntu1.1|1.2.19+ds1-2ubuntu1.1+esm1
    fixed_versions: vers:deb/1.2.19+ds1-2ubuntu1.1+esm2
severities:
  - score: '9.8'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    published_at: None
    url: https://github.com/canonical/ubuntu-security-notices/blob/main/osv/cve/2022/UBUNTU-CVE-2022-46169.json
  - score: high
    scoring_system: ubuntu-priority
    scoring_elements:
    published_at: None
    url: https://github.com/canonical/ubuntu-security-notices/blob/main/osv/cve/2022/UBUNTU-CVE-2022-46169.json
weaknesses: []
references:
  - url: https://github.com/Cacti/cacti/commit/7f0e16312dd5ce20f93744ef8b9c3b0f1ece2216
    reference_type:
    reference_id:
  - url: https://github.com/Cacti/cacti/commit/a8d59e8fa5f0054aa9c6981b1cbe30ef0e2a0ec9
    reference_type:
    reference_id:
  - url: https://github.com/Cacti/cacti/commit/b43f13ae7f1e6bfe4e8e56a80a7cd867cf2db52b
    reference_type:
    reference_id:
  - url: https://github.com/Cacti/cacti/security/advisories/GHSA-6p93-p743-35gf
    reference_type:
    reference_id:
  - url: https://ubuntu.com/security/CVE-2022-46169
    reference_type:
    reference_id:
  - url: https://ubuntu.com/security/notices/USN-7226-1
    reference_type:
    reference_id:
  - url: https://www.cisa.gov/known-exploited-vulnerabilities-catalog
    reference_type:
    reference_id:
  - url: https://www.cve.org/CVERecord?id=CVE-2022-46169
    reference_type:
    reference_id:
